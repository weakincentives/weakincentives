name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Use consolidated change detection (short-circuits on main branch push)
  detect-changes:
    uses: ./.github/workflows/detect-changes.yml

  # Consolidated static analysis job - runs all fast checks in one VM
  static-analysis:
    needs: detect-changes
    # Run on main push (run_all=true) or PRs with code changes
    if: needs.detect-changes.outputs.run_all == 'true' || needs.detect-changes.outputs.docs-only != 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
    - name: Set up Python
      run: uv python install 3.14
    - name: Install dependencies
      run: uv sync --all-extras
    - name: Run format check
      run: make format-check
    - name: Run linter
      run: make lint
    - name: Run ty
      run: make ty
    - name: Run pyright
      run: make pyright

  # Smart test job - runs targeted tests based on changed files
  test:
    needs: detect-changes
    if: needs.detect-changes.outputs.docs-only != 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
    - name: Set up Python
      run: uv python install 3.14
    - name: Install dependencies
      run: uv sync --all-extras

    # Run all tests on main push or when core/CI files change
    - name: Run all tests
      if: |
        needs.detect-changes.outputs.run_all == 'true' ||
        needs.detect-changes.outputs.core == 'true' ||
        needs.detect-changes.outputs.ci == 'true'
      run: make test

    # Run targeted tests for isolated module changes (PRs only)
    - name: Run targeted tests
      if: |
        needs.detect-changes.outputs.run_all != 'true' &&
        needs.detect-changes.outputs.core != 'true' &&
        needs.detect-changes.outputs.ci != 'true'
      env:
        ADAPTERS: ${{ needs.detect-changes.outputs.adapters }}
        RUNTIME: ${{ needs.detect-changes.outputs.runtime }}
        PROMPT: ${{ needs.detect-changes.outputs.prompt }}
        CONTRIB: ${{ needs.detect-changes.outputs.contrib }}
        EVALS: ${{ needs.detect-changes.outputs.evals }}
        SERDE: ${{ needs.detect-changes.outputs.serde }}
        CLI: ${{ needs.detect-changes.outputs.cli }}
      run: |
        # Build test path list based on changed modules
        TEST_PATHS=""
        [ "$ADAPTERS" = "true" ] && TEST_PATHS="$TEST_PATHS tests/adapters"
        [ "$RUNTIME" = "true" ] && TEST_PATHS="$TEST_PATHS tests/runtime"
        [ "$PROMPT" = "true" ] && TEST_PATHS="$TEST_PATHS tests/prompt tests/prompts"
        [ "$CONTRIB" = "true" ] && TEST_PATHS="$TEST_PATHS tests/contrib tests/tools"
        [ "$EVALS" = "true" ] && TEST_PATHS="$TEST_PATHS tests/evals"
        [ "$SERDE" = "true" ] && TEST_PATHS="$TEST_PATHS tests/serde"
        [ "$CLI" = "true" ] && TEST_PATHS="$TEST_PATHS tests/cli"

        if [ -z "$TEST_PATHS" ]; then
          echo "No specific test paths detected, running all tests"
          make test
        else
          echo "Running targeted tests: $TEST_PATHS"
          uv run --all-extras pytest --strict-config --strict-markers --maxfail=1 -q --no-header $TEST_PATHS
        fi

  mutation:
    needs: [detect-changes, test]
    # Run on main push or when runtime/serde modules change
    if: |
      needs.detect-changes.outputs.run_all == 'true' ||
      (needs.detect-changes.outputs.docs-only != 'true' &&
       (needs.detect-changes.outputs.runtime == 'true' || needs.detect-changes.outputs.serde == 'true'))
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
    - name: Set up Python
      run: uv python install 3.14
    - name: Install dependencies
      run: uv sync --all-extras
    - name: Enforce mutation score gate
      run: make mutation-check

  # Fast feedback for docs-only PRs
  docs-check:
    needs: detect-changes
    # Only run for docs-only PRs (not on main push where run_all=true)
    if: needs.detect-changes.outputs.run_all != 'true' && needs.detect-changes.outputs.docs-only == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
    - name: Set up Python
      run: uv python install 3.14
    - name: Install dependencies
      run: uv sync
    - name: Validate Markdown
      run: make markdown-check
    - name: Verify doc examples
      run: make verify-doc-examples
