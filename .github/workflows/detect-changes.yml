# Reusable Change Detection Workflow
#
# Consolidates all change detection logic into a single job. Short-circuits
# on push to main to run all validation checks without unnecessary filtering.
#
# Usage:
#   jobs:
#     changes:
#       uses: ./.github/workflows/detect-changes.yml
#
#     my-job:
#       needs: changes
#       if: needs.changes.outputs.run_all == 'true' || needs.changes.outputs.src == 'true'

name: Detect Changes

on:
  workflow_call:
    outputs:
      # Short-circuit flag - true on push to main, runs all checks
      run_all:
        description: 'Run all checks (short-circuit on main push)'
        value: ${{ jobs.detect.outputs.run_all }}
      # CI workflow outputs
      src:
        description: 'Source code changed'
        value: ${{ jobs.detect.outputs.src }}
      tests:
        description: 'Test files changed'
        value: ${{ jobs.detect.outputs.tests }}
      docs-only:
        description: 'Only documentation changed'
        value: ${{ jobs.detect.outputs.docs-only }}
      adapters:
        description: 'Adapter module changed'
        value: ${{ jobs.detect.outputs.adapters }}
      runtime:
        description: 'Runtime module changed'
        value: ${{ jobs.detect.outputs.runtime }}
      prompt:
        description: 'Prompt module changed'
        value: ${{ jobs.detect.outputs.prompt }}
      contrib:
        description: 'Contrib module changed'
        value: ${{ jobs.detect.outputs.contrib }}
      evals:
        description: 'Evals module changed'
        value: ${{ jobs.detect.outputs.evals }}
      serde:
        description: 'Serde module changed'
        value: ${{ jobs.detect.outputs.serde }}
      cli:
        description: 'CLI module changed'
        value: ${{ jobs.detect.outputs.cli }}
      core:
        description: 'Core infrastructure changed'
        value: ${{ jobs.detect.outputs.core }}
      ci:
        description: 'CI/CD configuration changed'
        value: ${{ jobs.detect.outputs.ci }}
      # Formal verification workflow outputs
      formal:
        description: 'Formal verification files changed'
        value: ${{ jobs.detect.outputs.formal }}
      mailbox:
        description: 'Mailbox implementation changed'
        value: ${{ jobs.detect.outputs.mailbox }}

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      run_all: ${{ steps.set-outputs.outputs.run_all }}
      src: ${{ steps.set-outputs.outputs.src }}
      tests: ${{ steps.set-outputs.outputs.tests }}
      docs-only: ${{ steps.set-outputs.outputs.docs-only }}
      adapters: ${{ steps.set-outputs.outputs.adapters }}
      runtime: ${{ steps.set-outputs.outputs.runtime }}
      prompt: ${{ steps.set-outputs.outputs.prompt }}
      contrib: ${{ steps.set-outputs.outputs.contrib }}
      evals: ${{ steps.set-outputs.outputs.evals }}
      serde: ${{ steps.set-outputs.outputs.serde }}
      cli: ${{ steps.set-outputs.outputs.cli }}
      core: ${{ steps.set-outputs.outputs.core }}
      ci: ${{ steps.set-outputs.outputs.ci }}
      formal: ${{ steps.set-outputs.outputs.formal }}
      mailbox: ${{ steps.set-outputs.outputs.mailbox }}

    steps:
      # Short-circuit: On push to main, skip change detection and run everything
      - name: Short-circuit for main branch push
        id: short-circuit
        if: github.event_name == 'push'
        run: echo "Pushing to main - all validation checks will run"

      # Only checkout and run change detection for pull requests
      - uses: actions/checkout@v5
        if: github.event_name != 'push'

      - uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name != 'push'
        with:
          filters: |
            src:
              - 'src/**'
            tests:
              - 'tests/**'
            docs-only:
              - '**/*.md'
              - 'docs/**'
              - '!src/**'
              - '!tests/**'
              - '!.github/**'
            adapters:
              - 'src/weakincentives/adapters/**'
              - 'tests/adapters/**'
            runtime:
              - 'src/weakincentives/runtime/**'
              - 'tests/runtime/**'
            prompt:
              - 'src/weakincentives/prompt/**'
              - 'tests/prompt/**'
              - 'tests/prompts/**'
            contrib:
              - 'src/weakincentives/contrib/**'
              - 'tests/contrib/**'
            evals:
              - 'src/weakincentives/evals/**'
              - 'tests/evals/**'
            serde:
              - 'src/weakincentives/serde/**'
              - 'tests/serde/**'
            cli:
              - 'src/weakincentives/cli/**'
              - 'tests/cli/**'
            core:
              - 'src/weakincentives/dbc/**'
              - 'src/weakincentives/types/**'
              - 'src/weakincentives/dataclasses/**'
              - 'src/weakincentives/resources/**'
              - 'src/weakincentives/filesystem/**'
              - 'pyproject.toml'
              - 'uv.lock'
            ci:
              - '.github/workflows/**'
              - 'Makefile'
            formal:
              - 'src/weakincentives/formal/**'
              - 'formal-tests/**'
              - 'specs/tla/**'
            mailbox:
              - 'src/weakincentives/contrib/mailbox/**'
              - 'tests/contrib/mailbox/**'

      # Set outputs based on event type
      - name: Set outputs
        id: set-outputs
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # Short-circuit: set run_all=true, all other filters are irrelevant
            # but we set docs-only=false to ensure code checks run
            {
              echo "run_all=true"
              echo "src=true"
              echo "tests=true"
              echo "docs-only=false"
              echo "adapters=true"
              echo "runtime=true"
              echo "prompt=true"
              echo "contrib=true"
              echo "evals=true"
              echo "serde=true"
              echo "cli=true"
              echo "core=true"
              echo "ci=true"
              echo "formal=true"
              echo "mailbox=true"
            } >> $GITHUB_OUTPUT
          else
            # Pull request: use actual change detection results
            {
              echo "run_all=false"
              echo "src=${{ steps.filter.outputs.src }}"
              echo "tests=${{ steps.filter.outputs.tests }}"
              echo "docs-only=${{ steps.filter.outputs.docs-only }}"
              echo "adapters=${{ steps.filter.outputs.adapters }}"
              echo "runtime=${{ steps.filter.outputs.runtime }}"
              echo "prompt=${{ steps.filter.outputs.prompt }}"
              echo "contrib=${{ steps.filter.outputs.contrib }}"
              echo "evals=${{ steps.filter.outputs.evals }}"
              echo "serde=${{ steps.filter.outputs.serde }}"
              echo "cli=${{ steps.filter.outputs.cli }}"
              echo "core=${{ steps.filter.outputs.core }}"
              echo "ci=${{ steps.filter.outputs.ci }}"
              echo "formal=${{ steps.filter.outputs.formal }}"
              echo "mailbox=${{ steps.filter.outputs.mailbox }}"
            } >> $GITHUB_OUTPUT
          fi
